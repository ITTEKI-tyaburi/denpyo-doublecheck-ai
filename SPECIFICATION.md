# 伝票ダブルチェック AI 仕様書
（最終更新日：2025-12-31）

---

## 概要
このAIは、**手書き会計伝票の画像**を解析し、  
会計行データを**推測せず正確に読み取り**、  
合計金額を算出して「記載合計」との一致を検証する。

---

## モード仕様

### 読み取りモード（`mode: read`）
- 手書き伝票を構造化JSONに変換する。
- 説明・補足は一切出さず、指定フォーマットのみ出力。

### 検算モード（`mode: check`）
- 算出合計・記載合計・判定をテキスト形式で出力。
- 【読取内訳】（行明細と根拠）と【警告】（日本語文）を併記。

既定は **検算モード**。

---

## 固定単価辞書（JPY）

| 品目名 | 単価 |
|--------|------|
| 飲み放題 最初の1h | 3300 |
| 飲み放題 延長30分 | 600 |
| ハッピーアワー 最初の1h | 1700 |
| 基本システム 1h | 1700 |
| 5時以降 延長 1h | 2200 |
| 単品ドリンク | 300 |
| ショット（700） | 700 |
| ショット（1100） | 1100 |
| キャストドリンク | 1100 |
| キャストショット | 1100 |
| テキーラ観覧車 | 8400 |

---

## 略語・人名ルール
- **D** → キャストドリンク（単価 1100）
- **S** → ショット（700 または 1100）
  - 価格指定がなければ「ショットの単価を記入してください（700円または1100円）」と警告。
- 人名（例：あおい、へらぽて）は `label` に含める。
  - 例：「へらぽて D」→「へらぽて キャストドリンク」

---

## 数量欄の判定ルール（正の字・棒線）

| 記号例 | 数量の解釈 |
|---------|-------------|

---

## 数量欄と金額欄の識別ルール

数量欄を誤って金額欄と混同しないよう、以下の位置的・書式的特徴に基づいて判断する。

### 数量欄の特徴
- 通常、品目名（または人名＋品目）の**直右側**に位置。
- 記号的記述（「正」「｜」「一」「／」「＼」など）が多く、**漢数字やアラビア数字が1桁または空欄に近い短い記述**。
- 小数点（.）、カンマ（,）、円記号（¥）、桁区切り（例：1,100）などを含まない。
- 縦列で複数行に並ぶ傾向がある。
- 判読対象が数式（例：×1100）に近い場合、「数量」として扱う。

### 金額欄の特徴
- 通常、伝票右端に位置。
- アラビア数字が3桁以上（例：3300, 1100, 600 など）。
- 円記号（¥）やカンマ（,）、桁区切りを含む可能性がある。
- 縦方向ではなく**右端に整列**している。
- 「合計」「TOTAL」「小計」などの近傍に現れる数値は**数量ではなく金額**として無視する。

### 判定ロジック
1. 数量候補文字列に「正」「｜」「／」「一」等が含まれる → 数量確定。
2. 数値のみの場合：
   - 桁数が2桁以下、かつ右隣が単価列 → 数量として採用。
   - 桁数が3桁以上 → 金額欄として除外。
3. 行全体の構造が「（ラベル）→（数量候補）→（単価候補）→（金額）」の形を取る場合、  
   左から順に数量・単価・金額と解釈する。

4. 不確実な場合は、数量をnullとし、  
   「数量欄が金額欄と判別できませんでした」と警告を出す。

---

---

## 伝票レイアウト仕様（固定フォーマット）

この伝票は横方向に以下の構造で印字・記入される。  
全ての行は、左から右に以下の順序で構成される。

| 列 | 内容 | 記述例 | 特徴 |
|----|------|--------|------|
| 1 | 品目・人名ラベル | へらぽて D / あおい S / 飲み放題 | 日本語文字列または略語。人名＋品目が含まれる。 |
| 2 | 数量欄 | 正 / ｜｜ / 一一一 / 正+一 | 記号的（正・棒線など）。2〜6文字程度。右隣に単価欄がある。 |
| 3 | 単価欄 | 1100 / 700 / 3300 | アラビア数字3〜4桁。円記号なし。数量×単価の対象。 |
| 4 | 金額欄 | 2200 / 6600 / 3300 | アラビア数字3〜5桁。右端に整列。合計計算対象外（算出用ではなく印字済み金額）。 |

### 補足ルール
- **数量欄（列2）を優先**して読み取る。金額欄（列4）の数値は、合計計算には使用しない。
- 「数量欄が空欄で金額のみ記載」の場合は、行を無視せず、警告を出して記録。
  - 例：「金額は記載されていますが数量が未記入です」。
- 「単価」と「金額」の両方が存在し、整合が取れない場合：
  - 数量=金額÷単価（割り算で整数結果の場合のみ）とし、evidence に「数量を金額÷単価から補完」と記載。
  - 端数が出る場合は補完せず、「数量が判定できませんでした」と警告。

---

